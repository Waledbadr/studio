# EstateCare - نظام إدارة العقارات الشامل

## 📋 نظرة عامة

**EstateCare** هو تطبيق ويب شامل لإدارة العقارات السكنية والمجمعات والمنشآت. تم تطويره باستخدام Next.js وFirebase لتوفير حل متكامل لإدارة الصيانة والمخزون والطلبيات والسكان.

## 🌟 المميزات الرئيسية

### 🏠 إدارة العقارات
- **تعريف هيكل العقارات**: إنشاء وإدارة المجمعات السكنية والمباني والطوابق والغرف والحمامات والمرافق
- **إدارة السكان**: تتبع سكان العقارات ومعلوماتهم
- **تقارير العقارات**: إحصائيات شاملة حول العقارات والمساكن

### 🔧 نظام الصيانة
- **طلبات الصيانة**: إرسال ومتابعة طلبات الصيانة للعقارات أو الغرف
- **مساعد الرؤى الذكية**: مساعد مدعوم بالذكاء الاصطناعي يقترح حلولاً مماثلة بناءً على الأوصاف
- **مساعد الامتثال**: إرشادات لضمان جودة التقارير والامتثال للمعايير
- **تتبع حالة الطلبات**: متابعة شاملة لجميع مراحل الصيانة

### 📦 إدارة المخزون الشاملة
- **إدارة الأصناف**: كتالوج شامل لجميع المواد والأدوات
- **تتبع المخزون**: مراقبة دقيقة لأرصدة المخزون والحركات
- **طلبيات المواد (MR)**: نظام طلبيات شامل مع الموافقات
- **استلام المواد (MRV)**: إدارة عمليات الاستلام والتوزيع
- **إصدار المواد (MIV)**: نظام إصدار المواد للمشاريع والصيانة
- **نقل المخزون**: نقل المواد بين المواقع المختلفة
- **جرد المخزون**: نظام جرد شامل لمطابقة الأرصدة
- **تقارير متقدمة**: تقارير مفصلة لحركة المخزون والتكاليف

### 👥 إدارة المستخدمين والصلاحيات
- **أدوار متعددة**: مدير عام، مدير موقع، فني صيانة
- **صلاحيات محددة**: تحكم دقيق في الوصول حسب الدور
- **تخصيص العقارات**: ربط المستخدمين بعقارات محددة

### 🎨 نظام الثيمات المتقدم
- **7 مجموعات ألوان**: تشكيلة متنوعة من الألوان لتناسب جميع الأذواق
- **3 أوضاع عرض**: فاتح، داكن، حسب النظام
- **حفظ شخصي**: إعدادات منفصلة لكل مستخدم
- **تطبيق فوري**: تغيير فوري بدون إعادة تحميل

## 🚀 التقنيات المستخدمة

### Frontend Framework
- **Next.js 15.3.3** - إطار عمل React متقدم
- **React 18** - مكتبة واجهة المستخدم
- **TypeScript** - لغة برمجة مكتوبة بقوة

### UI Framework & Styling
- **Tailwind CSS 3.4** - إطار عمل CSS متقدم
- **Radix UI** - مكونات واجهة مستخدم متقدمة
- **Lucide React** - مكتبة أيقونات حديثة
- **shadcn/ui** - نظام تصميم متقدم

### Backend & Database
- **Firebase 11.9.1** - منصة تطوير شاملة
- **Firestore** - قاعدة بيانات NoSQL
- **Firebase Authentication** - نظام المصادقة
- **Firebase Hosting** - استضافة التطبيق

### AI Integration
- **Google AI (Genkit)** - تكامل الذكاء الاصطناعي
- **Gemini API** - نماذج لغوية متقدمة

### Development Tools
- **ESLint** - فحص جودة الكود
- **PostCSS** - معالج CSS
- **Date-fns** - مكتبة التعامل مع التواريخ

## 📁 هيكل المشروع

```
EstateCare/
├── src/
│   ├── app/                    # صفحات التطبيق (App Router)
│   │   ├── inventory/          # صفحات المخزون
│   │   ├── maintenance/        # صفحات الصيانة
│   │   ├── residences/         # صفحات العقارات
│   │   ├── users/              # إدارة المستخدمين
│   │   └── setup/              # الإعدادات العامة
│   ├── components/             # مكونات قابلة لإعادة الاستخدام
│   │   ├── ui/                 # مكونات واجهة المستخدم الأساسية
│   │   ├── inventory/          # مكونات المخزون
│   │   ├── layout/             # مكونات التخطيط
│   │   └── residences/         # مكونات العقارات
│   ├── context/                # مزودو السياق (Context Providers)
│   ├── hooks/                  # خطافات React مخصصة
│   ├── lib/                    # مكتبات مساعدة
│   └── ai/                     # تكامل الذكاء الاصطناعي
├── docs/                       # الوثائق التقنية
├── firebase.json               # إعدادات Firebase
├── firestore.rules             # قواعد أمان Firestore
└── package.json                # تبعيات المشروع
```

## ⚙️ التثبيت والإعداد

### المتطلبات الأساسية
- Node.js (الإصدار 18 أو أحدث)
- npm أو yarn
- حساب Firebase
- Git

### خطوات التثبيت

1. **استنساخ المشروع**
   ```powershell
   git clone [repository-url]
   cd studio
   ```

2. **تثبيت التبعيات**
   ```powershell
   npm install
   ```

3. **إعداد Firebase**
   - إنشاء مشروع جديد في [Firebase Console](https://console.firebase.google.com)
   - تفعيل Firestore Database
   - تفعيل Authentication (Email/Password + أي موفرات تريدها مثل Google/Microsoft)
   - تفعيل Hosting (اختياري للتجربة المحلية)

4. **تكوين متغيرات البيئة**
   - انسخ الملف `.env.local.example` إلى `.env.local` ثم عبئ القيم من إعدادات تطبيق الويب في Firebase (Project settings > General > Your apps):
   ```bash
   NEXT_PUBLIC_FIREBASE_API_KEY=...
   NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=...
   NEXT_PUBLIC_FIREBASE_PROJECT_ID=...
   NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=...
   NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=...
   NEXT_PUBLIC_FIREBASE_APP_ID=...
   ```
   - في وضع التطوير يمكنك أيضًا الاعتماد على `.env.development` المرفق كتجربة، لكن يُفضّل إنشاء مشروع Firebase منفصل لك.
   - لتفعيل WebAuthn (اختياري)، اترك `NEXT_PUBLIC_WEBAUTHN_RPID=localhost` أثناء التطوير.

   ملاحظات مهمة لتجنب خطأ `auth/invalid-credential`:
   - تأكد من صحة البريد/كلمة المرور وأن المستخدم موجود في Authentication > Users.
   - تحقق من أن `Authorized domains` في Firebase Authentication تحتوي `localhost` واسم نطاقك.
   - في حال استخدام Google/Microsoft، فعّل الموفر واضبط Client ID/Secret، وأضف `http://localhost:9002` ضمن النطاقات المسموح بها للعودة إن لزم.
   - إن نقرت "Continue with Google" ورأيت الخطأ، فالسبب غالبًا نطاق غير مصرح به أو موفر غير مفعّل.

5. **تشغيل التطبيق في وضع التطوير**
   ```powershell
   npm run dev
   ```
   
   سيتم تشغيل التطبيق على: `http://localhost:9002`

## 🔧 أوامر التطوير

### تطوير التطبيق
```powershell
npm run dev              # تشغيل خادم التطوير مع Turbopack
npm run build           # بناء التطبيق للإنتاج
npm start              # تشغيل التطبيق المبني
npm run lint           # فحص الكود
npm run typecheck      # فحص TypeScript
```

### تطوير الذكاء الاصطناعي
```powershell
npm run genkit:dev     # تشغيل خادم Genkit
npm run genkit:watch   # تشغيل Genkit مع مراقبة التغييرات
```

### إشعارات الدفع (اختياري)

- أضف VAPID key عام لـ Web Push: أضف `NEXT_PUBLIC_FCM_VAPID_KEY` إلى `.env.local`.
- تأكد من وجود `public/firebase-messaging-sw.js` (تمت إضافته). يمكن تخصيصه للتعامل مع الرسائل في الخلفية.
- التطبيق سيحفظ رمز FCM فقط عندما تكون صلاحية الإشعارات ممنوحة مسبقاً.

### رفع الملفات (Vercel Blob)

- هذا المشروع يستخدم Vercel Blob لرفع المرفقات (صور/فواتير) عبر المسارات:
   - POST `/api/uploads/feedback`
   - POST `/api/uploads/mrv-invoice`
- يجب توفير متغير البيئة التالي في جميع البيئات التي تُشغِّل هذه المسارات:
   - `BLOB_READ_WRITE_TOKEN`

إعداد محلي:

1) أنشئ ملف `.env.local` في جذر المشروع وضع القيمة:

```
BLOB_READ_WRITE_TOKEN=vercel_blob_rw_token_here
```

2) أعد تشغيل dev server بعد إضافة المتغير.

نشر على Vercel:

- أضف `BLOB_READ_WRITE_TOKEN` من إعدادات المشروع -> Environment Variables.
- تأكد من أن المتغير موجود على بيئة Preview و Production عند الحاجة.

ملاحظات:

- إذا ظهر الخطأ: `Vercel Blob: No token found...` فهذا يعني أن المتغير غير مضبوط أو غير متاح في بيئة التشغيل الحالية.
- يمكن تمرير `token` بشكل صريح لاستدعاءات SDK، والمشروع يفعل ذلك بالفعل للمسارات المذكورة.

## 📚 الوحدات الرئيسية

### 1. إدارة المخزون
- **المواد**: كتالوج شامل مع الفئات والوحدات
- **الأرصدة**: تتبع دقيق لكميات المخزون
- **الحركات**: سجل شامل لجميع العمليات
- **الطلبيات**: نظام طلبيات متكامل
- **الجرد**: مطابقة دورية للأرصدة

### 2. نظام الصيانة
- **الطلبات**: إدارة شاملة لطلبات الصيانة
- **التتبع**: متابعة مراحل العمل
- **التقارير**: تحليلات أداء الصيانة
- **المساعد الذكي**: اقتراحات مدعومة بالذكاء الاصطناعي

### 3. إدارة العقارات
- **الهيكل**: تعريف مرن للمجمعات والمباني
- **السكان**: إدارة بيانات السكان
- **المرافق**: تصنيف وإدارة المرافق

## 🎨 نظام التصميم

### الألوان الرئيسية
- **الأساسي**: #5DADE2 (أزرق هادئ ومهني)
- **الخلفية**: #F2F8FD (أزرق فاتح جداً)
- **التمييز**: #E85D04 (برتقالي مشرق)

### الخطوط
- **خط أساسي**: Inter (خط حديث وواضح)
- **مصدر الخطوط**: Google Fonts

### المبادئ التصميمية
- تخطيط واضح ومنطقي
- أيقونات بسيطة ومعبرة
- تقليل التعقيد للمستخدمين غير التقنيين
- تنقل مبسط وسهل

## 🔐 الأمان والصلاحيات

### قواعد Firestore
- حماية شاملة للبيانات
- تحكم دقيق في الوصول
- مصادقة إجبارية

### أدوار المستخدمين
- **Admin**: صلاحيات كاملة
- **Manager**: إدارة موقع محدد
- **Technician**: تنفيذ المهام

## 📊 التقارير والتحليلات

### تقارير المخزون
- حركة المواد
- تحليل التكاليف
- مستويات الأمان
- تقارير الجرد

### تقارير الصيانة
- أداء الفرق
- معدلات الإنجاز
- تحليل الأعطال المتكررة
- تكاليف الصيانة

## 🌍 الدعم متعدد اللغات

التطبيق يدعم حالياً:
- العربية (الافتراضية)
- الإنجليزية

مع إمكانية إضافة لغات أخرى بسهولة.

## 📱 التوافق والاستجابة

- تصميم متجاوب لجميع أحجام الشاشات
- دعم الهواتف والأجهزة اللوحية
- تحسين الأداء للشبكات البطيئة
- دعم المتصفحات الحديثة

## 🚀 النشر والإنتاج

### النشر على Firebase Hosting
```powershell
npm run build
firebase deploy
```

### متطلبات الإنتاج
- خادم Node.js (للوظائف الخلفية)
- قاعدة بيانات Firebase
- شهادة SSL
- نطاق مخصص (اختياري)

## 🤝 المساهمة

### قواعد المساهمة
1. فحص الكود قبل الإرسال
2. كتابة تعليقات واضحة
3. اتباع معايير التصميم
4. اختبار شامل للتغييرات

### بنية البرانشات
- `main`: النسخة المستقرة
- `development`: التطوير النشط
- `feature/*`: مميزات جديدة
- `bugfix/*`: إصلاح الأخطاء

## 📞 الدعم والمساعدة

### الوثائق التقنية
- `docs/blueprint.md` - مخطط التطبيق
- `docs/INVENTORY_AUDIT_SYSTEM.md` - نظام الجرد
- `docs/THEMES.md` - نظام الثيمات

### التواصل
للدعم التقني أو الاستفسارات، يرجى إنشاء Issue في المشروع أو التواصل مع فريق التطوير.

## 📄 الترخيص

هذا المشروع محمي بموجب [رخصة MIT](LICENSE) - راجع ملف الترخيص للتفاصيل.

---

تم تطوير EstateCare بعناية فائقة لتوفير حل شامل ومتطور لإدارة العقارات والمجمعات السكنية. التطبيق قابل للتوسيع والتخصيص ليناسب احتياجات مختلف أنواع المنشآت.

**النسخة**: 0.1.0  
**آخر تحديث**: أغسطس 2025

## 🛠️ صيانة المخزون السالب (Admins)

لتفادي تكرار ظهور مخزون بقيم سالبة وضمان تصحيحه بسرعة، يتوفّر مسار صيانة:

- الفحص فقط:
   - GET `/api/inventory/fix-negative`
- تطبيق الإصلاح (يطالب بمفتاح صيانة في الإنتاج):
   - POST `/api/inventory/fix-negative` مع الترويسة `x-maint-key: <MAINT_KEY>`
   - أو GET `/api/inventory/fix-negative?apply=1&key=<MAINT_KEY>`

ملاحظات:
- في التطوير (NODE_ENV != production)، يمكن تطبيق الإصلاح دون `MAINT_KEY` لتسهيل الاختبار.
- أضف `MAINT_KEY=strong_random_value` إلى `.env.local` (وأي بيئة نشر) لتقييد التنفيذ.
- الإصلاح يصفّر كل قيمة سالبة في `stockByResidence`، يعيد احتساب الحقل الإجمالي `stock`، ويسجّل حركة ADJUSTMENT لكل تصحيح تحت المرجع `AUTO-FIX-NEGATIVE`.

كما تم تدعيم العمليات الأساسية (إصدار/تحويل/إهلاك/جرد) لتكون معاملاتية بقراءة-تعديل-كتابة مع منع تحت-التدفق، وإعادة احتساب الإجمالي من `stockByResidence` لضمان الاتساق.
